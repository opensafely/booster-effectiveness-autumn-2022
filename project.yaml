version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/*.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process initial data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_initial:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_initial
      --output-file output/initial/extract/input_initial.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/initial/extract/input_initial.feather

  dummydata_initial:
    run: r:latest analysis/dummydata/dummydata_initial.R
    needs:
    - extract_initial
    outputs:
      highly_sensitive:
        dummydata: output/initial/dummydata/*.feather

  process_initial:
    run: r:latest analysis/process/process_initial.R
    needs:
    - extract_initial
    - dummydata_initial
    outputs:
      highly_sensitive:
        data_eligible: output/initial/eligible/*.csv.gz
        data_vax: output/initial/eligible/*.rds
      moderately_sensitive:
        flowchart: output/initial/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/treated/extract/input_treated.feather
    needs:
    - process_initial
    outputs:
      highly_sensitive:
        extract: output/treated/extract/input_treated.feather

  dummydata_stage:
    run: r:latest analysis/dummydata/dummydata_stage.R
    needs:
    - dummydata_initial
    - process_initial
    - extract_treated
    outputs:
      highly_sensitive:
        dummydata_treated: output/treated/dummydata/*.feather
        dummydata_controlpotential: output/matchround1/controlpotential/dummydata/*.feather

  process_treated:
    run: r:latest analysis/process/process_stage.R treated
    needs:
    - process_initial
    - extract_treated
    - dummydata_stage
    outputs:
      highly_sensitive:
        eligiblerds: output/treated/eligible/*.rds
        eligiblecsv: output/treated/eligible/*.csv.gz
      moderately_sensitive:
        flowchart: output/treated/flowchart/*.csv
        extract_treated_skim: output/treated/extract/*.txt
        data_processed_skim: output/treated/process/*.txt
        data_eligible_skim: output/treated/eligible/*.txt

  table1_treated:
    run: r:latest analysis/report/table1.R treated
    needs:
    - process_treated
    outputs:
      moderately_sensitive:
        csv: output/treated/table1/table1_treated_midpoint6.csv
        html: output/treated/table1/table1_treated_midpoint6.html

  extract_outcomes_alltreated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_outcomes
      --output-file output/outcomes/input_outcomes_alltreated.feather --param group=alltreated
    needs:
    - design
    - process_treated
    outputs:
      highly_sensitive:
        cohort: output/outcomes/input_outcomes_alltreated.feather

  