version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/*.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process initial data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_initial:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_initial
      --output-file output/initial/extract/input_initial.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/initial/extract/input_initial.feather

  process_initial:
    run: r:latest analysis/process/process_initial.R
    needs:
    - extract_initial
    outputs:
      highly_sensitive:
        data_eligible: output/initial/eligible/*.csv.gz
        data_vax: output/initial/eligible/*.rds
      moderately_sensitive:
        flow: output/initial/eligible/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/treated/extract/input_treated.feather
    needs:
    - process_initial
    outputs:
      highly_sensitive:
        extract: output/treated/extract/input_treated.feather

  process_treated:
    run: r:latest analysis/process/process_data.R treated
    needs:
    - extract_treated
    outputs:
      highly_sensitive:
        eligiblerds: output/treated/eligible/*.rds
        pfizer: output/pfizer/treated/*.rds
        moderna: output/moderna/treated/*.rds
      moderately_sensitive:
        eligiblecsv: output/treated/eligible/*.csv
        input_treated_skim: output/treated/extract/*.txt
        data_processed_skim: output/treated/process/*.txt
        data_eligible_skim: output/treated/eligible/*.txt

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract, process and match control data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_controlpotential_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround1/extract/input_controlpotential.feather --param
      matching_round=1 --param index_date=2022-09-12
    needs:
    - design
    - process_initial
    outputs:
      highly_sensitive:
        cohort: output/matchround1/extract/input_controlpotential.feather

  process_controlpotential_1:
    run: r:latest analysis/process/process_data.R potential 1
    needs:
    - extract_controlpotential_1
    outputs:
      highly_sensitive:
        rds: output/matchround1/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/matchround1/extract/potential/*.txt
        data_processed_skim: output/matchround1/potential/*.txt
        data_controlpotential_skim: output/matchround1/process/*.txt

  match_potential_1:
    run: r:latest analysis/matching/match_potential.R 1
    needs:
    - process_treated
    - process_controlpotential_1
    outputs:
      highly_sensitive:
        rds: output/matchround1/potential/*.rds
        csv: output/matchround1/potential/*.csv.gz

  extract_controlactual_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround1/extract/input_controlactual.feather --param
      matching_round=1
    needs:
    - design
    - match_potential_1
    outputs:
      highly_sensitive:
        cohort: output/matchround1/extract/input_controlactual.feather

  process_controlactual_1:
    run: r:latest analysis/process/process_data.R actual 1
    needs:
    - process_treated
    - match_potential_1
    - extract_controlpotential_1
    - process_controlpotential_1
    - extract_controlactual_1
    outputs:
      highly_sensitive:
        rds: output/matchround1/actual/*.rds
        csv: output/matchround1/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/matchround1/extract/actual/*.txt
        data_actual_skim: output/matchround1/actual/*.txt

  extract_controlpotential_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround2/extract/input_controlpotential.feather --param
      matching_round=2 --param index_date=2022-09-26
    needs:
    - design
    - process_initial
    - process_controlactual_1
    outputs:
      highly_sensitive:
        cohort: output/matchround2/extract/input_controlpotential.feather

  process_controlpotential_2:
    run: r:latest analysis/process/process_data.R potential 2
    needs:
    - extract_controlpotential_2
    outputs:
      highly_sensitive:
        rds: output/matchround2/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/matchround2/extract/potential/*.txt
        data_processed_skim: output/matchround2/potential/*.txt
        data_controlpotential_skim: output/matchround2/process/*.txt

  match_potential_2:
    run: r:latest analysis/matching/match_potential.R 2
    needs:
    - process_treated
    - process_controlpotential_2
    - process_controlactual_1
    outputs:
      highly_sensitive:
        rds: output/matchround2/potential/*.rds
        csv: output/matchround2/potential/*.csv.gz

  extract_controlactual_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround2/extract/input_controlactual.feather --param
      matching_round=2
    needs:
    - design
    - match_potential_2
    outputs:
      highly_sensitive:
        cohort: output/matchround2/extract/input_controlactual.feather

  process_controlactual_2:
    run: r:latest analysis/process/process_data.R actual 2
    needs:
    - process_treated
    - match_potential_2
    - extract_controlpotential_2
    - process_controlpotential_2
    - extract_controlactual_2
    - process_controlactual_1
    outputs:
      highly_sensitive:
        rds: output/matchround2/actual/*.rds
        csv: output/matchround2/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/matchround2/extract/actual/*.txt
        data_actual_skim: output/matchround2/actual/*.txt

  extract_controlfinal:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlfinal
      --output-file output/extract/input_controlfinal.feather --param n_matching_rounds=2
    needs:
    - design
    - process_controlactual_2
    outputs:
      highly_sensitive:
        extract: output/extract/input_controlfinal.feather

  dummydata_controlfinal:
    run: r:latest analysis/dummy/dummydata_controlfinal.R
    needs:
    - process_controlactual_1
    - process_controlactual_2
    outputs:
      highly_sensitive:
        dummydata_controlfinal: output/dummydata/dummy_control_final.feather

  process_controlfinal:
    run: r:latest analysis/process/process_data.R final
    needs:
    - process_controlactual_1
    - process_controlactual_2
    - extract_controlfinal
    - process_treated
    - dummydata_controlfinal
    outputs:
      highly_sensitive:
        extract: output/match/*.rds
        ids: output/match/*.csv.gz
      moderately_sensitive:
        input_controlfinal_skim: output/extract/*.txt
        data_matched_skim: output/match/*.txt

  ## #### End #### 

