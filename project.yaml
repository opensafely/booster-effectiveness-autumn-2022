version: '3.0'

expectations:

  population_size: 1000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/*.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process initial data. 
  ## The initial extract comprises vacination data 
  ## and static variables (i.e. not defined at a timepoint, 
  ## e.g. sex, ethnicity etc). 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_initial:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_initial
      --output-file output/initial/extract/input_initial.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/initial/extract/input_initial.feather

  dummydata_initial:
    run: r:latest analysis/dummydata/dummydata_initial.R
    needs:
    - extract_initial
    outputs:
      highly_sensitive:
        dummydata: output/initial/dummydata/*.feather

  process_initial:
    run: r:latest analysis/process/process_initial.R
    needs:
    - extract_initial
    - dummydata_initial
    outputs:
      highly_sensitive:
        data_vax: output/initial/processed/*.rds
        data_eligible_csv: output/initial/eligible/*.csv.gz
      moderately_sensitive:
        flowchart: output/initial/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process riskscore_i data. 
  ## These data are extracted from a period prior 
  ## to the start of the main study period, and are 
  ## used to fit a linear predictor of death. This 
  ## model is then used to predict the probability of 
  ## death during follow-up (riskscore_i), and individuals 
  ## are matched on these probabilities. 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_riskscore_i:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_riskscore_i
      --output-file output/riskscore_i/extract/input_riskscore_i.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/riskscore_i/extract/input_riskscore_i.feather

  dummydata_stage:
    run: r:latest analysis/dummydata/dummydata_stage.R
    needs:
    - dummydata_initial
    - process_initial
    outputs:
      highly_sensitive:
        dummydata_treated: output/treated/dummydata/*.feather
        dummydata_controlpotential: output/incremental_none/matchround1/controlpotential/dummydata/*.feather

  process_riskscore_i:
    run: r:latest analysis/process/process_stage.R riskscore_i riskscore_i 0
    needs:
    - process_initial
    - extract_riskscore_i
    - dummydata_stage
    outputs:
      highly_sensitive:
        eligiblerds: output/riskscore_i/eligible/*.rds
      moderately_sensitive:
        flowchart: output/riskscore_i/flowchart/*.csv
        extract_skim: output/riskscore_i/extract/*.txt
        data_processed_skim: output/riskscore_i/processed/*.txt
        data_eligible_skim: output/riskscore_i/eligible/*.txt

  fit_model_riskscore_i_1:
    run: r:latest analysis/riskscore/model_fit.R 1
    needs:
    - process_riskscore_i
    outputs:
      highly_sensitive:
        model: output/riskscore_i/agegroup_1/model_agegroup_*.rds
        percentile_breaks: output/riskscore_i/agegroup_1/percentile_breaks_*.rds
      moderately_sensitive:
        dist_predictions: output/riskscore_i/agegroup_1/dist_predictions_*.png
        calibration: output/riskscore_i/agegroup_1/calibration_*.png
        binned_residuals: output/riskscore_i/agegroup_1/binned_residuals_*.png

  fit_model_riskscore_i_2:
    run: r:latest analysis/riskscore/model_fit.R 2
    needs:
    - process_riskscore_i
    outputs:
      highly_sensitive:
        model: output/riskscore_i/agegroup_2/model_agegroup_*.rds
        percentile_breaks: output/riskscore_i/agegroup_2/percentile_breaks_*.rds
      moderately_sensitive:
        dist_predictions: output/riskscore_i/agegroup_2/dist_predictions_*.png
        calibration: output/riskscore_i/agegroup_2/calibration_*.png
        binned_residuals: output/riskscore_i/agegroup_2/binned_residuals_*.png

  fit_model_riskscore_i_3:
    run: r:latest analysis/riskscore/model_fit.R 3
    needs:
    - process_riskscore_i
    outputs:
      highly_sensitive:
        model: output/riskscore_i/agegroup_3/model_agegroup_*.rds
        percentile_breaks: output/riskscore_i/agegroup_3/percentile_breaks_*.rds
      moderately_sensitive:
        dist_predictions: output/riskscore_i/agegroup_3/dist_predictions_*.png
        calibration: output/riskscore_i/agegroup_3/calibration_*.png
        binned_residuals: output/riskscore_i/agegroup_3/binned_residuals_*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data. 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/treated/extract/input_treated.feather
    needs:
    - process_initial
    outputs:
      highly_sensitive:
        extract: output/treated/extract/input_treated.feather

  process_treated:
    run: r:latest analysis/process/process_stage.R treated none 0
    needs:
    - process_initial
    - extract_treated
    - dummydata_stage
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        eligiblerds: output/treated/eligible/*.rds
        eligiblecsv: output/treated/eligible/*.csv.gz
      moderately_sensitive:
        riskscore_i_plots: output/treated/riskscore_i/plot_*.png
        flowchart_treated: output/treated/flowchart/*.csv
        flowchart_combined: output/report/flowchart_combined*.csv
        extract_treated_skim: output/treated/extract/*.txt
        data_processed_skim: output/treated/processed/*.txt
        data_eligible_skim: output/treated/eligible/*.txt

  table1_treated:
    run: r:latest analysis/report/table1.R treated none
    needs:
    - process_treated
    - extract_final_treated
    outputs:
      moderately_sensitive:
        csv: output/treated/table1/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Match treated for comparative effectiveness 
  ## match_strategy = a 
  ## # # # # # # # # # # # # # # # # # # # 

  match_comparative_a:
    run: r:latest analysis/match/match_comparative.R a
    needs:
    - process_treated
    outputs:
      highly_sensitive:
        rds: output/comparative_a/match/*.rds

  table1_comparative_a:
    run: r:latest analysis/report/table1.R comparative a
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/table1/*.csv

  coverage_comparative_a:
    run: r:latest analysis/match/match_coverage.R comparative a
    needs:
    - process_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/coverage/*.csv
        png: output/comparative_a/coverage/*.png

  flowchart_comparative_a:
    run: r:latest analysis/match/match_flowchart.R comparative a
    needs:
    - process_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Match treated for comparative effectiveness 
  ## match_strategy = riskscore_i 
  ## # # # # # # # # # # # # # # # # # # # 

  match_comparative_riskscore_i:
    run: r:latest analysis/match/match_comparative.R riskscore_i
    needs:
    - process_treated
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        rds: output/comparative_riskscore_i/match/*.rds

  table1_comparative_riskscore_i:
    run: r:latest analysis/report/table1.R comparative riskscore_i
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/table1/*.csv

  coverage_comparative_riskscore_i:
    run: r:latest analysis/match/match_coverage.R comparative riskscore_i
    needs:
    - process_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/coverage/*.csv
        png: output/comparative_riskscore_i/coverage/*.png

  flowchart_comparative_riskscore_i:
    run: r:latest analysis/match/match_flowchart.R comparative riskscore_i
    needs:
    - process_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract adjustment and outcome variables for all treated people 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_final_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_final
      --output-file output/treated/extract/input_final_treated.feather --param effect=comparative
      --param match_strategy=none
    needs:
    - design
    - process_treated
    outputs:
      highly_sensitive:
        cohort: output/treated/extract/input_final_treated.feather

  ## # # # # # # # # # # # # # # # # # # # 
  ## Fit models for comparative effectiveness match_strategy = a 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_all_covidadmitted:
    run: r:latest analysis/model/km.R comparative a all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/all/covidadmitted/*.csv
        png: output/comparative_a/model/km/all/covidadmitted/*.png

  cox_unadj_comparative_a_all_covidadmitted:
    run: r:latest analysis/model/cox.R comparative a cox_unadj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/all/covidadmitted/*.csv

  cox_adj_comparative_a_all_covidadmitted:
    run: r:latest analysis/model/cox.R comparative a cox_adj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/all/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_all_coviddeath:
    run: r:latest analysis/model/km.R comparative a all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/all/coviddeath/*.csv
        png: output/comparative_a/model/km/all/coviddeath/*.png

  cox_unadj_comparative_a_all_coviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_unadj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/all/coviddeath/*.csv

  cox_adj_comparative_a_all_coviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_adj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/all/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_all_noncoviddeath:
    run: r:latest analysis/model/km.R comparative a all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/all/noncoviddeath/*.csv
        png: output/comparative_a/model/km/all/noncoviddeath/*.png

  cox_unadj_comparative_a_all_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_unadj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/all/noncoviddeath/*.csv

  cox_adj_comparative_a_all_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_adj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/all/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_all_fracture:
    run: r:latest analysis/model/km.R comparative a all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/all/fracture/*.csv
        png: output/comparative_a/model/km/all/fracture/*.png

  cox_unadj_comparative_a_all_fracture:
    run: r:latest analysis/model/cox.R comparative a cox_unadj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/all/fracture/*.csv

  cox_adj_comparative_a_all_fracture:
    run: r:latest analysis/model/cox.R comparative a cox_adj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/all/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_agegroup_match_covidadmitted:
    run: r:latest analysis/model/km.R comparative a agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/agegroup_match/covidadmitted/*.csv
        png: output/comparative_a/model/km/agegroup_match/covidadmitted/*.png

  cox_unadj_comparative_a_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R comparative a cox_unadj agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/agegroup_match/covidadmitted/*.csv

  cox_adj_comparative_a_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R comparative a cox_adj agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/agegroup_match/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_agegroup_match_coviddeath:
    run: r:latest analysis/model/km.R comparative a agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/agegroup_match/coviddeath/*.csv
        png: output/comparative_a/model/km/agegroup_match/coviddeath/*.png

  cox_unadj_comparative_a_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_unadj agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/agegroup_match/coviddeath/*.csv

  cox_adj_comparative_a_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_adj agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/agegroup_match/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/km.R comparative a agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/agegroup_match/noncoviddeath/*.csv
        png: output/comparative_a/model/km/agegroup_match/noncoviddeath/*.png

  cox_unadj_comparative_a_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_unadj agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/agegroup_match/noncoviddeath/*.csv

  cox_adj_comparative_a_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative a cox_adj agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/agegroup_match/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_a_agegroup_match_fracture:
    run: r:latest analysis/model/km.R comparative a agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/km/agegroup_match/fracture/*.csv
        png: output/comparative_a/model/km/agegroup_match/fracture/*.png

  cox_unadj_comparative_a_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R comparative a cox_unadj agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_unadj/agegroup_match/fracture/*.csv

  cox_adj_comparative_a_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R comparative a cox_adj agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_a
    outputs:
      moderately_sensitive:
        csv: output/comparative_a/model/cox_adj/agegroup_match/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_all_covidadmitted:
    run: r:latest analysis/model/km.R comparative riskscore_i all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/all/covidadmitted/*.csv
        png: output/comparative_riskscore_i/model/km/all/covidadmitted/*.png

  cox_unadj_comparative_riskscore_i_all_covidadmitted:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/all/covidadmitted/*.csv

  cox_adj_comparative_riskscore_i_all_covidadmitted:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/all/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_all_coviddeath:
    run: r:latest analysis/model/km.R comparative riskscore_i all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/all/coviddeath/*.csv
        png: output/comparative_riskscore_i/model/km/all/coviddeath/*.png

  cox_unadj_comparative_riskscore_i_all_coviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/all/coviddeath/*.csv

  cox_adj_comparative_riskscore_i_all_coviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/all/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_all_noncoviddeath:
    run: r:latest analysis/model/km.R comparative riskscore_i all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/all/noncoviddeath/*.csv
        png: output/comparative_riskscore_i/model/km/all/noncoviddeath/*.png

  cox_unadj_comparative_riskscore_i_all_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/all/noncoviddeath/*.csv

  cox_adj_comparative_riskscore_i_all_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/all/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_all_fracture:
    run: r:latest analysis/model/km.R comparative riskscore_i all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/all/fracture/*.csv
        png: output/comparative_riskscore_i/model/km/all/fracture/*.png

  cox_unadj_comparative_riskscore_i_all_fracture:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/all/fracture/*.csv

  cox_adj_comparative_riskscore_i_all_fracture:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/all/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_agegroup_match_covidadmitted:
    run: r:latest analysis/model/km.R comparative riskscore_i agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/agegroup_match/covidadmitted/*.csv
        png: output/comparative_riskscore_i/model/km/agegroup_match/covidadmitted/*.png

  cox_unadj_comparative_riskscore_i_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj agegroup_match
      covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/agegroup_match/covidadmitted/*.csv

  cox_adj_comparative_riskscore_i_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj agegroup_match
      covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/agegroup_match/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_agegroup_match_coviddeath:
    run: r:latest analysis/model/km.R comparative riskscore_i agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/agegroup_match/coviddeath/*.csv
        png: output/comparative_riskscore_i/model/km/agegroup_match/coviddeath/*.png

  cox_unadj_comparative_riskscore_i_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj agegroup_match
      coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/agegroup_match/coviddeath/*.csv

  cox_adj_comparative_riskscore_i_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj agegroup_match
      coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/agegroup_match/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/km.R comparative riskscore_i agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/agegroup_match/noncoviddeath/*.csv
        png: output/comparative_riskscore_i/model/km/agegroup_match/noncoviddeath/*.png

  cox_unadj_comparative_riskscore_i_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj agegroup_match
      noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/agegroup_match/noncoviddeath/*.csv

  cox_adj_comparative_riskscore_i_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj agegroup_match
      noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/agegroup_match/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_riskscore_i_agegroup_match_fracture:
    run: r:latest analysis/model/km.R comparative riskscore_i agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/km/agegroup_match/fracture/*.csv
        png: output/comparative_riskscore_i/model/km/agegroup_match/fracture/*.png

  cox_unadj_comparative_riskscore_i_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_unadj agegroup_match
      fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_unadj/agegroup_match/fracture/*.csv

  cox_adj_comparative_riskscore_i_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R comparative riskscore_i cox_adj agegroup_match
      fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_comparative_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/comparative_riskscore_i/model/cox_adj/agegroup_match/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Combine comparative model outputs for match_strategy = a 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  combine_model_comparative_a:
    run: r:latest analysis/model/combine_model.R comparative a
    needs:
    - km_comparative_a_all_covidadmitted
    - km_comparative_a_all_coviddeath
    - km_comparative_a_all_noncoviddeath
    - km_comparative_a_all_fracture
    - km_comparative_a_agegroup_match_covidadmitted
    - km_comparative_a_agegroup_match_coviddeath
    - km_comparative_a_agegroup_match_noncoviddeath
    - km_comparative_a_agegroup_match_fracture
    - cox_unadj_comparative_a_all_covidadmitted
    - cox_unadj_comparative_a_all_coviddeath
    - cox_unadj_comparative_a_all_noncoviddeath
    - cox_unadj_comparative_a_all_fracture
    - cox_unadj_comparative_a_agegroup_match_covidadmitted
    - cox_unadj_comparative_a_agegroup_match_coviddeath
    - cox_unadj_comparative_a_agegroup_match_noncoviddeath
    - cox_unadj_comparative_a_agegroup_match_fracture
    - cox_adj_comparative_a_all_covidadmitted
    - cox_adj_comparative_a_all_coviddeath
    - cox_adj_comparative_a_all_noncoviddeath
    - cox_adj_comparative_a_all_fracture
    - cox_adj_comparative_a_agegroup_match_covidadmitted
    - cox_adj_comparative_a_agegroup_match_coviddeath
    - cox_adj_comparative_a_agegroup_match_noncoviddeath
    - cox_adj_comparative_a_agegroup_match_fracture
    outputs:
      moderately_sensitive:
        rds: output/comparative_a/model/*.csv
        png: output/comparative_a/model/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Combine comparative model outputs for match_strategy = riskscore_i 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  combine_model_comparative_riskscore_i:
    run: r:latest analysis/model/combine_model.R comparative riskscore_i
    needs:
    - km_comparative_riskscore_i_all_covidadmitted
    - km_comparative_riskscore_i_all_coviddeath
    - km_comparative_riskscore_i_all_noncoviddeath
    - km_comparative_riskscore_i_all_fracture
    - km_comparative_riskscore_i_agegroup_match_covidadmitted
    - km_comparative_riskscore_i_agegroup_match_coviddeath
    - km_comparative_riskscore_i_agegroup_match_noncoviddeath
    - km_comparative_riskscore_i_agegroup_match_fracture
    - cox_unadj_comparative_riskscore_i_all_covidadmitted
    - cox_unadj_comparative_riskscore_i_all_coviddeath
    - cox_unadj_comparative_riskscore_i_all_noncoviddeath
    - cox_unadj_comparative_riskscore_i_all_fracture
    - cox_unadj_comparative_riskscore_i_agegroup_match_covidadmitted
    - cox_unadj_comparative_riskscore_i_agegroup_match_coviddeath
    - cox_unadj_comparative_riskscore_i_agegroup_match_noncoviddeath
    - cox_unadj_comparative_riskscore_i_agegroup_match_fracture
    - cox_adj_comparative_riskscore_i_all_covidadmitted
    - cox_adj_comparative_riskscore_i_all_coviddeath
    - cox_adj_comparative_riskscore_i_all_noncoviddeath
    - cox_adj_comparative_riskscore_i_all_fracture
    - cox_adj_comparative_riskscore_i_agegroup_match_covidadmitted
    - cox_adj_comparative_riskscore_i_agegroup_match_coviddeath
    - cox_adj_comparative_riskscore_i_agegroup_match_noncoviddeath
    - cox_adj_comparative_riskscore_i_agegroup_match_fracture
    outputs:
      moderately_sensitive:
        rds: output/comparative_riskscore_i/model/*.csv
        png: output/comparative_riskscore_i/model/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process controlpotential1 data. 
  ## This can be done once for all matching strategies. 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_controlpotential_none_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/incremental_none/matchround1/controlpotential/extract/input_controlpotential.feather
      --param match_strategy=none --param match_round=1 --param index_date=2022-09-12
    needs:
    - design
    - process_initial
    outputs:
      highly_sensitive:
        cohort: output/incremental_none/matchround1/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_none_1:
    run: r:latest analysis/process/process_stage.R controlpotential none 1
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_none_1
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        eligible_rds: output/incremental_none/matchround1/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/incremental_none/matchround1/controlpotential/extract/*.txt
        data_processed_skim: output/incremental_none/matchround1/controlpotential/processed/*.txt
        data_controlpotential_skim: output/incremental_none/matchround1/controlpotential/eligible/*.txt
        flowchart: output/incremental_none/matchround1/controlpotential/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Match treated for incremental effectiveness 
  ## match_strategy = a 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract, process and match controlpotential data. 
  ## Match_round = 1 

  match_controlpotential_a_1:
    run: r:latest analysis/match/match_controlpotential.R a 1
    needs:
    - process_treated
    - process_controlpotential_none_1
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround1/controlpotential/match/*.rds
        csv: output/incremental_a/matchround1/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_a_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_a/matchround1/controlactual/extract/input_controlactual.feather
      --param match_strategy=a --param match_round=1
    needs:
    - design
    - match_controlpotential_a_1
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround1/controlactual/extract/input_controlactual.feather

  process_controlactual_a_1:
    run: r:latest analysis/process/process_stage.R controlactual a 1
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_a_1
    - extract_controlactual_a_1
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_a/matchround1/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_a/matchround1/controlactual/extract/*.txt
        eligible_skim: output/incremental_a/matchround1/controlactual/eligible/*.txt
        process_skim: output/incremental_a/matchround1/controlactual/processed/*.txt
        flowchart: output/incremental_a/matchround1/controlactual/flowchart/*.csv

  match_controlactual_a_1:
    run: r:latest analysis/match/match_controlactual.R a 1
    needs:
    - process_initial
    - process_treated
    - match_controlpotential_a_1
    - process_controlactual_a_1
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround1/controlactual/match/*.rds
        csvgz: output/incremental_a/matchround1/controlactual/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_a/matchround1/controlactual/match/*.csv

  ## Extract, process and match controlpotential data. 
  ## Match_round = 2 

  extract_controlpotential_a_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/incremental_a/matchround2/controlpotential/extract/input_controlpotential.feather
      --param match_strategy=a --param match_round=2 --param index_date=2022-09-26
    needs:
    - design
    - match_controlactual_a_1
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround2/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_a_2:
    run: r:latest analysis/process/process_stage.R controlpotential a 2
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_a_2
    outputs:
      highly_sensitive:
        eligible_rds: output/incremental_a/matchround2/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/incremental_a/matchround2/controlpotential/extract/*.txt
        data_processed_skim: output/incremental_a/matchround2/controlpotential/processed/*.txt
        data_controlpotential_skim: output/incremental_a/matchround2/controlpotential/eligible/*.txt
        flowchart: output/incremental_a/matchround2/controlpotential/flowchart/*.csv

  match_controlpotential_a_2:
    run: r:latest analysis/match/match_controlpotential.R a 2
    needs:
    - process_treated
    - process_controlpotential_a_2
    - match_controlactual_a_1
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround2/controlpotential/match/*.rds
        csv: output/incremental_a/matchround2/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_a_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_a/matchround2/controlactual/extract/input_controlactual.feather
      --param match_strategy=a --param match_round=2
    needs:
    - design
    - match_controlpotential_a_2
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround2/controlactual/extract/input_controlactual.feather

  process_controlactual_a_2:
    run: r:latest analysis/process/process_stage.R controlactual a 2
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_a_2
    - extract_controlactual_a_2
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_a/matchround2/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_a/matchround2/controlactual/extract/*.txt
        eligible_skim: output/incremental_a/matchround2/controlactual/eligible/*.txt
        process_skim: output/incremental_a/matchround2/controlactual/processed/*.txt
        flowchart: output/incremental_a/matchround2/controlactual/flowchart/*.csv

  match_controlactual_a_2:
    run: r:latest analysis/match/match_controlactual.R a 2
    needs:
    - process_initial
    - process_treated
    - match_controlactual_a_1
    - match_controlpotential_a_2
    - process_controlactual_a_2
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround2/controlactual/match/*.rds
        csvgz: output/incremental_a/matchround2/controlactual/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_a/matchround2/controlactual/match/*.csv

  ## Extract, process and match controlpotential data. 
  ## Match_round = 3 

  extract_controlpotential_a_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/incremental_a/matchround3/controlpotential/extract/input_controlpotential.feather
      --param match_strategy=a --param match_round=3 --param index_date=2022-10-10
    needs:
    - design
    - match_controlactual_a_2
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround3/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_a_3:
    run: r:latest analysis/process/process_stage.R controlpotential a 3
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_a_3
    outputs:
      highly_sensitive:
        eligible_rds: output/incremental_a/matchround3/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/incremental_a/matchround3/controlpotential/extract/*.txt
        data_processed_skim: output/incremental_a/matchround3/controlpotential/processed/*.txt
        data_controlpotential_skim: output/incremental_a/matchround3/controlpotential/eligible/*.txt
        flowchart: output/incremental_a/matchround3/controlpotential/flowchart/*.csv

  match_controlpotential_a_3:
    run: r:latest analysis/match/match_controlpotential.R a 3
    needs:
    - process_treated
    - process_controlpotential_a_3
    - match_controlactual_a_1
    - match_controlactual_a_2
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround3/controlpotential/match/*.rds
        csv: output/incremental_a/matchround3/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_a_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_a/matchround3/controlactual/extract/input_controlactual.feather
      --param match_strategy=a --param match_round=3
    needs:
    - design
    - match_controlpotential_a_3
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround3/controlactual/extract/input_controlactual.feather

  process_controlactual_a_3:
    run: r:latest analysis/process/process_stage.R controlactual a 3
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_a_3
    - extract_controlactual_a_3
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_a/matchround3/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_a/matchround3/controlactual/extract/*.txt
        eligible_skim: output/incremental_a/matchround3/controlactual/eligible/*.txt
        process_skim: output/incremental_a/matchround3/controlactual/processed/*.txt
        flowchart: output/incremental_a/matchround3/controlactual/flowchart/*.csv

  match_controlactual_a_3:
    run: r:latest analysis/match/match_controlactual.R a 3
    needs:
    - process_initial
    - process_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlpotential_a_3
    - process_controlactual_a_3
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround3/controlactual/match/*.rds
        csvgz: output/incremental_a/matchround3/controlactual/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_a/matchround3/controlactual/match/*.csv

  ## Extract, process and match controlpotential data. 
  ## Match_round = 4 

  extract_controlpotential_a_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/incremental_a/matchround4/controlpotential/extract/input_controlpotential.feather
      --param match_strategy=a --param match_round=4 --param index_date=2022-10-24
    needs:
    - design
    - match_controlactual_a_3
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround4/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_a_4:
    run: r:latest analysis/process/process_stage.R controlpotential a 4
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_a_4
    outputs:
      highly_sensitive:
        eligible_rds: output/incremental_a/matchround4/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/incremental_a/matchround4/controlpotential/extract/*.txt
        data_processed_skim: output/incremental_a/matchround4/controlpotential/processed/*.txt
        data_controlpotential_skim: output/incremental_a/matchround4/controlpotential/eligible/*.txt
        flowchart: output/incremental_a/matchround4/controlpotential/flowchart/*.csv

  match_controlpotential_a_4:
    run: r:latest analysis/match/match_controlpotential.R a 4
    needs:
    - process_treated
    - process_controlpotential_a_4
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround4/controlpotential/match/*.rds
        csv: output/incremental_a/matchround4/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_a_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_a/matchround4/controlactual/extract/input_controlactual.feather
      --param match_strategy=a --param match_round=4
    needs:
    - design
    - match_controlpotential_a_4
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/matchround4/controlactual/extract/input_controlactual.feather

  process_controlactual_a_4:
    run: r:latest analysis/process/process_stage.R controlactual a 4
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_a_4
    - extract_controlactual_a_4
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_a/matchround4/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_a/matchround4/controlactual/extract/*.txt
        eligible_skim: output/incremental_a/matchround4/controlactual/eligible/*.txt
        process_skim: output/incremental_a/matchround4/controlactual/processed/*.txt
        flowchart: output/incremental_a/matchround4/controlactual/flowchart/*.csv

  match_controlactual_a_4:
    run: r:latest analysis/match/match_controlactual.R a 4
    needs:
    - process_initial
    - process_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlpotential_a_4
    - process_controlactual_a_4
    outputs:
      highly_sensitive:
        rds: output/incremental_a/matchround4/controlactual/match/*.rds
        final: output/incremental_a/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_a/matchround4/controlactual/match/*.csv

  coverage_incremental_a:
    run: r:latest analysis/match/match_coverage.R incremental a
    needs:
    - process_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/coverage/*.csv
        png: output/incremental_a/coverage/*.png

  flowchart_incremental_a:
    run: r:latest analysis/match/match_flowchart.R incremental a
    needs:
    - process_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - process_initial
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract adjustment and outcome variables for final matched controls 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_final_incremental_a:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_final
      --output-file output/incremental_a/match/input_final_a.feather --param effect=incremental
      --param match_strategy=a
    needs:
    - design
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    outputs:
      highly_sensitive:
        cohort: output/incremental_a/match/input_final_a.feather

  table1_incremental_a:
    run: r:latest analysis/report/table1.R incremental a
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/table1/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Fit models to estimate incremental effectiveness 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_all_covidadmitted:
    run: r:latest analysis/model/km.R incremental a all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/all/covidadmitted/*.csv
        png: output/incremental_a/model/km/all/covidadmitted/*.png

  cox_unadj_incremental_a_all_covidadmitted:
    run: r:latest analysis/model/cox.R incremental a cox_unadj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/all/covidadmitted/*.csv

  cox_adj_incremental_a_all_covidadmitted:
    run: r:latest analysis/model/cox.R incremental a cox_adj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/all/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_all_coviddeath:
    run: r:latest analysis/model/km.R incremental a all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/all/coviddeath/*.csv
        png: output/incremental_a/model/km/all/coviddeath/*.png

  cox_unadj_incremental_a_all_coviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_unadj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/all/coviddeath/*.csv

  cox_adj_incremental_a_all_coviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_adj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/all/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_all_noncoviddeath:
    run: r:latest analysis/model/km.R incremental a all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/all/noncoviddeath/*.csv
        png: output/incremental_a/model/km/all/noncoviddeath/*.png

  cox_unadj_incremental_a_all_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_unadj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/all/noncoviddeath/*.csv

  cox_adj_incremental_a_all_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_adj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/all/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_all_fracture:
    run: r:latest analysis/model/km.R incremental a all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/all/fracture/*.csv
        png: output/incremental_a/model/km/all/fracture/*.png

  cox_unadj_incremental_a_all_fracture:
    run: r:latest analysis/model/cox.R incremental a cox_unadj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/all/fracture/*.csv

  cox_adj_incremental_a_all_fracture:
    run: r:latest analysis/model/cox.R incremental a cox_adj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/all/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_agegroup_match_covidadmitted:
    run: r:latest analysis/model/km.R incremental a agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/agegroup_match/covidadmitted/*.csv
        png: output/incremental_a/model/km/agegroup_match/covidadmitted/*.png

  cox_unadj_incremental_a_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R incremental a cox_unadj agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/agegroup_match/covidadmitted/*.csv

  cox_adj_incremental_a_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R incremental a cox_adj agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/agegroup_match/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_agegroup_match_coviddeath:
    run: r:latest analysis/model/km.R incremental a agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/agegroup_match/coviddeath/*.csv
        png: output/incremental_a/model/km/agegroup_match/coviddeath/*.png

  cox_unadj_incremental_a_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_unadj agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/agegroup_match/coviddeath/*.csv

  cox_adj_incremental_a_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_adj agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/agegroup_match/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/km.R incremental a agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/agegroup_match/noncoviddeath/*.csv
        png: output/incremental_a/model/km/agegroup_match/noncoviddeath/*.png

  cox_unadj_incremental_a_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_unadj agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/agegroup_match/noncoviddeath/*.csv

  cox_adj_incremental_a_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental a cox_adj agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/agegroup_match/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_a_agegroup_match_fracture:
    run: r:latest analysis/model/km.R incremental a agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/km/agegroup_match/fracture/*.csv
        png: output/incremental_a/model/km/agegroup_match/fracture/*.png

  cox_unadj_incremental_a_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R incremental a cox_unadj agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_unadj/agegroup_match/fracture/*.csv

  cox_adj_incremental_a_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R incremental a cox_adj agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_a_1
    - match_controlactual_a_2
    - match_controlactual_a_3
    - match_controlactual_a_4
    - extract_final_incremental_a
    outputs:
      moderately_sensitive:
        csv: output/incremental_a/model/cox_adj/agegroup_match/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Combine incremental model outputs for match_strategy = a 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  combine_model_incremental_a:
    run: r:latest analysis/model/combine_model.R incremental a
    needs:
    - km_incremental_a_all_covidadmitted
    - km_incremental_a_all_coviddeath
    - km_incremental_a_all_noncoviddeath
    - km_incremental_a_all_fracture
    - km_incremental_a_agegroup_match_covidadmitted
    - km_incremental_a_agegroup_match_coviddeath
    - km_incremental_a_agegroup_match_noncoviddeath
    - km_incremental_a_agegroup_match_fracture
    - cox_unadj_incremental_a_all_covidadmitted
    - cox_unadj_incremental_a_all_coviddeath
    - cox_unadj_incremental_a_all_noncoviddeath
    - cox_unadj_incremental_a_all_fracture
    - cox_unadj_incremental_a_agegroup_match_covidadmitted
    - cox_unadj_incremental_a_agegroup_match_coviddeath
    - cox_unadj_incremental_a_agegroup_match_noncoviddeath
    - cox_unadj_incremental_a_agegroup_match_fracture
    - cox_adj_incremental_a_all_covidadmitted
    - cox_adj_incremental_a_all_coviddeath
    - cox_adj_incremental_a_all_noncoviddeath
    - cox_adj_incremental_a_all_fracture
    - cox_adj_incremental_a_agegroup_match_covidadmitted
    - cox_adj_incremental_a_agegroup_match_coviddeath
    - cox_adj_incremental_a_agegroup_match_noncoviddeath
    - cox_adj_incremental_a_agegroup_match_fracture
    outputs:
      moderately_sensitive:
        rds: output/incremental_a/model/*.csv
        png: output/incremental_a/model/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Match treated for incremental effectiveness 
  ## match_strategy = riskscore_i 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract, process and match controlpotential data. 
  ## Match_round = 1 

  match_controlpotential_riskscore_i_1:
    run: r:latest analysis/match/match_controlpotential.R riskscore_i 1
    needs:
    - process_treated
    - process_controlpotential_none_1
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        rds: output/incremental_riskscore_i/matchround1/controlpotential/match/*.rds
        csv: output/incremental_riskscore_i/matchround1/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_riskscore_i_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_riskscore_i/matchround1/controlactual/extract/input_controlactual.feather
      --param match_strategy=riskscore_i --param match_round=1
    needs:
    - design
    - match_controlpotential_riskscore_i_1
    outputs:
      highly_sensitive:
        cohort: output/incremental_riskscore_i/matchround1/controlactual/extract/input_controlactual.feather

  process_controlactual_riskscore_i_1:
    run: r:latest analysis/process/process_stage.R controlactual riskscore_i 1
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_riskscore_i_1
    - extract_controlactual_riskscore_i_1
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_riskscore_i/matchround1/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_riskscore_i/matchround1/controlactual/extract/*.txt
        eligible_skim: output/incremental_riskscore_i/matchround1/controlactual/eligible/*.txt
        process_skim: output/incremental_riskscore_i/matchround1/controlactual/processed/*.txt
        flowchart: output/incremental_riskscore_i/matchround1/controlactual/flowchart/*.csv
        riskscore_i_plots: output/incremental_riskscore_i/matchround1/controlactual/riskscore_i/plot_*.png

  match_controlactual_riskscore_i_1:
    run: r:latest analysis/match/match_controlactual.R riskscore_i 1
    needs:
    - process_initial
    - process_treated
    - match_controlpotential_riskscore_i_1
    - process_controlactual_riskscore_i_1
    outputs:
      highly_sensitive:
        rds: output/incremental_riskscore_i/matchround1/controlactual/match/*.rds
        csvgz: output/incremental_riskscore_i/matchround1/controlactual/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_riskscore_i/matchround1/controlactual/match/*.csv

  ## Extract, process and match controlpotential data. 
  ## Match_round = 2 

  extract_controlpotential_riskscore_i_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/incremental_riskscore_i/matchround2/controlpotential/extract/input_controlpotential.feather
      --param match_strategy=riskscore_i --param match_round=2 --param index_date=2022-09-26
    needs:
    - design
    - match_controlactual_riskscore_i_1
    outputs:
      highly_sensitive:
        cohort: output/incremental_riskscore_i/matchround2/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_riskscore_i_2:
    run: r:latest analysis/process/process_stage.R controlpotential riskscore_i 2
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_riskscore_i_2
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        eligible_rds: output/incremental_riskscore_i/matchround2/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/incremental_riskscore_i/matchround2/controlpotential/extract/*.txt
        data_processed_skim: output/incremental_riskscore_i/matchround2/controlpotential/processed/*.txt
        data_controlpotential_skim: output/incremental_riskscore_i/matchround2/controlpotential/eligible/*.txt
        flowchart: output/incremental_riskscore_i/matchround2/controlpotential/flowchart/*.csv
        riskscore_i_plots: output/incremental_riskscore_i/matchround2/controlpotential/riskscore_i/plot_*.png

  match_controlpotential_riskscore_i_2:
    run: r:latest analysis/match/match_controlpotential.R riskscore_i 2
    needs:
    - process_treated
    - process_controlpotential_riskscore_i_2
    - match_controlactual_riskscore_i_1
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        rds: output/incremental_riskscore_i/matchround2/controlpotential/match/*.rds
        csv: output/incremental_riskscore_i/matchround2/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_riskscore_i_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_riskscore_i/matchround2/controlactual/extract/input_controlactual.feather
      --param match_strategy=riskscore_i --param match_round=2
    needs:
    - design
    - match_controlpotential_riskscore_i_2
    outputs:
      highly_sensitive:
        cohort: output/incremental_riskscore_i/matchround2/controlactual/extract/input_controlactual.feather

  process_controlactual_riskscore_i_2:
    run: r:latest analysis/process/process_stage.R controlactual riskscore_i 2
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_riskscore_i_2
    - extract_controlactual_riskscore_i_2
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_riskscore_i/matchround2/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_riskscore_i/matchround2/controlactual/extract/*.txt
        eligible_skim: output/incremental_riskscore_i/matchround2/controlactual/eligible/*.txt
        process_skim: output/incremental_riskscore_i/matchround2/controlactual/processed/*.txt
        flowchart: output/incremental_riskscore_i/matchround2/controlactual/flowchart/*.csv
        riskscore_i_plots: output/incremental_riskscore_i/matchround2/controlactual/riskscore_i/plot_*.png

  match_controlactual_riskscore_i_2:
    run: r:latest analysis/match/match_controlactual.R riskscore_i 2
    needs:
    - process_initial
    - process_treated
    - match_controlactual_riskscore_i_1
    - match_controlpotential_riskscore_i_2
    - process_controlactual_riskscore_i_2
    outputs:
      highly_sensitive:
        rds: output/incremental_riskscore_i/matchround2/controlactual/match/*.rds
        csvgz: output/incremental_riskscore_i/matchround2/controlactual/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_riskscore_i/matchround2/controlactual/match/*.csv

  ## Extract, process and match controlpotential data. 
  ## Match_round = 3 

  extract_controlpotential_riskscore_i_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/incremental_riskscore_i/matchround3/controlpotential/extract/input_controlpotential.feather
      --param match_strategy=riskscore_i --param match_round=3 --param index_date=2022-10-10
    needs:
    - design
    - match_controlactual_riskscore_i_2
    outputs:
      highly_sensitive:
        cohort: output/incremental_riskscore_i/matchround3/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_riskscore_i_3:
    run: r:latest analysis/process/process_stage.R controlpotential riskscore_i 3
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_riskscore_i_3
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        eligible_rds: output/incremental_riskscore_i/matchround3/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/incremental_riskscore_i/matchround3/controlpotential/extract/*.txt
        data_processed_skim: output/incremental_riskscore_i/matchround3/controlpotential/processed/*.txt
        data_controlpotential_skim: output/incremental_riskscore_i/matchround3/controlpotential/eligible/*.txt
        flowchart: output/incremental_riskscore_i/matchround3/controlpotential/flowchart/*.csv
        riskscore_i_plots: output/incremental_riskscore_i/matchround3/controlpotential/riskscore_i/plot_*.png

  match_controlpotential_riskscore_i_3:
    run: r:latest analysis/match/match_controlpotential.R riskscore_i 3
    needs:
    - process_treated
    - process_controlpotential_riskscore_i_3
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        rds: output/incremental_riskscore_i/matchround3/controlpotential/match/*.rds
        csv: output/incremental_riskscore_i/matchround3/controlpotential/match/*.csv.gz

  ## Extract and process controlactual data 
  ## (matches checked and rematched in the process action). 

  extract_controlactual_riskscore_i_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/incremental_riskscore_i/matchround3/controlactual/extract/input_controlactual.feather
      --param match_strategy=riskscore_i --param match_round=3
    needs:
    - design
    - match_controlpotential_riskscore_i_3
    outputs:
      highly_sensitive:
        cohort: output/incremental_riskscore_i/matchround3/controlactual/extract/input_controlactual.feather

  process_controlactual_riskscore_i_3:
    run: r:latest analysis/process/process_stage.R controlactual riskscore_i 3
    needs:
    - process_initial
    - dummydata_stage
    - match_controlpotential_riskscore_i_3
    - extract_controlactual_riskscore_i_3
    - fit_model_riskscore_i_1
    - fit_model_riskscore_i_2
    - fit_model_riskscore_i_3
    outputs:
      highly_sensitive:
        data_eligible: output/incremental_riskscore_i/matchround3/controlactual/eligible/*.rds
      moderately_sensitive:
        input_skim: output/incremental_riskscore_i/matchround3/controlactual/extract/*.txt
        eligible_skim: output/incremental_riskscore_i/matchround3/controlactual/eligible/*.txt
        process_skim: output/incremental_riskscore_i/matchround3/controlactual/processed/*.txt
        flowchart: output/incremental_riskscore_i/matchround3/controlactual/flowchart/*.csv
        riskscore_i_plots: output/incremental_riskscore_i/matchround3/controlactual/riskscore_i/plot_*.png

  match_controlactual_riskscore_i_3:
    run: r:latest analysis/match/match_controlactual.R riskscore_i 3
    needs:
    - process_initial
    - process_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlpotential_riskscore_i_3
    - process_controlactual_riskscore_i_3
    outputs:
      highly_sensitive:
        rds: output/incremental_riskscore_i/matchround3/controlactual/match/*.rds
        final: output/incremental_riskscore_i/match/*.csv.gz
      moderately_sensitive:
        csv: output/incremental_riskscore_i/matchround3/controlactual/match/*.csv

  coverage_incremental_riskscore_i:
    run: r:latest analysis/match/match_coverage.R incremental riskscore_i
    needs:
    - process_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/coverage/*.csv
        png: output/incremental_riskscore_i/coverage/*.png

  flowchart_incremental_riskscore_i:
    run: r:latest analysis/match/match_flowchart.R incremental riskscore_i
    needs:
    - process_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - process_initial
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract adjustment and outcome variables for final matched controls 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_final_incremental_riskscore_i:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_final
      --output-file output/incremental_riskscore_i/match/input_final_riskscore_i.feather
      --param effect=incremental --param match_strategy=riskscore_i
    needs:
    - design
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    outputs:
      highly_sensitive:
        cohort: output/incremental_riskscore_i/match/input_final_riskscore_i.feather

  table1_incremental_riskscore_i:
    run: r:latest analysis/report/table1.R incremental riskscore_i
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/table1/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Fit models to estimate incremental effectiveness 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_all_covidadmitted:
    run: r:latest analysis/model/km.R incremental riskscore_i all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/all/covidadmitted/*.csv
        png: output/incremental_riskscore_i/model/km/all/covidadmitted/*.png

  cox_unadj_incremental_riskscore_i_all_covidadmitted:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/all/covidadmitted/*.csv

  cox_adj_incremental_riskscore_i_all_covidadmitted:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj all covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/all/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_all_coviddeath:
    run: r:latest analysis/model/km.R incremental riskscore_i all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/all/coviddeath/*.csv
        png: output/incremental_riskscore_i/model/km/all/coviddeath/*.png

  cox_unadj_incremental_riskscore_i_all_coviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/all/coviddeath/*.csv

  cox_adj_incremental_riskscore_i_all_coviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj all coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/all/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_all_noncoviddeath:
    run: r:latest analysis/model/km.R incremental riskscore_i all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/all/noncoviddeath/*.csv
        png: output/incremental_riskscore_i/model/km/all/noncoviddeath/*.png

  cox_unadj_incremental_riskscore_i_all_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/all/noncoviddeath/*.csv

  cox_adj_incremental_riskscore_i_all_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj all noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/all/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_all_fracture:
    run: r:latest analysis/model/km.R incremental riskscore_i all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/all/fracture/*.csv
        png: output/incremental_riskscore_i/model/km/all/fracture/*.png

  cox_unadj_incremental_riskscore_i_all_fracture:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/all/fracture/*.csv

  cox_adj_incremental_riskscore_i_all_fracture:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj all fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/all/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_agegroup_match_covidadmitted:
    run: r:latest analysis/model/km.R incremental riskscore_i agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/agegroup_match/covidadmitted/*.csv
        png: output/incremental_riskscore_i/model/km/agegroup_match/covidadmitted/*.png

  cox_unadj_incremental_riskscore_i_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj agegroup_match
      covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/agegroup_match/covidadmitted/*.csv

  cox_adj_incremental_riskscore_i_agegroup_match_covidadmitted:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj agegroup_match
      covidadmitted
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/agegroup_match/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_agegroup_match_coviddeath:
    run: r:latest analysis/model/km.R incremental riskscore_i agegroup_match coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/agegroup_match/coviddeath/*.csv
        png: output/incremental_riskscore_i/model/km/agegroup_match/coviddeath/*.png

  cox_unadj_incremental_riskscore_i_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj agegroup_match
      coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/agegroup_match/coviddeath/*.csv

  cox_adj_incremental_riskscore_i_agegroup_match_coviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj agegroup_match
      coviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/agegroup_match/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/km.R incremental riskscore_i agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/agegroup_match/noncoviddeath/*.csv
        png: output/incremental_riskscore_i/model/km/agegroup_match/noncoviddeath/*.png

  cox_unadj_incremental_riskscore_i_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj agegroup_match
      noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/agegroup_match/noncoviddeath/*.csv

  cox_adj_incremental_riskscore_i_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj agegroup_match
      noncoviddeath
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/agegroup_match/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_incremental_riskscore_i_agegroup_match_fracture:
    run: r:latest analysis/model/km.R incremental riskscore_i agegroup_match fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/km/agegroup_match/fracture/*.csv
        png: output/incremental_riskscore_i/model/km/agegroup_match/fracture/*.png

  cox_unadj_incremental_riskscore_i_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_unadj agegroup_match
      fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_unadj/agegroup_match/fracture/*.csv

  cox_adj_incremental_riskscore_i_agegroup_match_fracture:
    run: r:latest analysis/model/cox.R incremental riskscore_i cox_adj agegroup_match
      fracture
    needs:
    - process_treated
    - extract_final_treated
    - match_controlactual_riskscore_i_1
    - match_controlactual_riskscore_i_2
    - match_controlactual_riskscore_i_3
    - extract_final_incremental_riskscore_i
    outputs:
      moderately_sensitive:
        csv: output/incremental_riskscore_i/model/cox_adj/agegroup_match/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Combine incremental model outputs for match_strategy = riskscore_i 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  combine_model_incremental_riskscore_i:
    run: r:latest analysis/model/combine_model.R incremental riskscore_i
    needs:
    - km_incremental_riskscore_i_all_covidadmitted
    - km_incremental_riskscore_i_all_coviddeath
    - km_incremental_riskscore_i_all_noncoviddeath
    - km_incremental_riskscore_i_all_fracture
    - km_incremental_riskscore_i_agegroup_match_covidadmitted
    - km_incremental_riskscore_i_agegroup_match_coviddeath
    - km_incremental_riskscore_i_agegroup_match_noncoviddeath
    - km_incremental_riskscore_i_agegroup_match_fracture
    - cox_unadj_incremental_riskscore_i_all_covidadmitted
    - cox_unadj_incremental_riskscore_i_all_coviddeath
    - cox_unadj_incremental_riskscore_i_all_noncoviddeath
    - cox_unadj_incremental_riskscore_i_all_fracture
    - cox_unadj_incremental_riskscore_i_agegroup_match_covidadmitted
    - cox_unadj_incremental_riskscore_i_agegroup_match_coviddeath
    - cox_unadj_incremental_riskscore_i_agegroup_match_noncoviddeath
    - cox_unadj_incremental_riskscore_i_agegroup_match_fracture
    - cox_adj_incremental_riskscore_i_all_covidadmitted
    - cox_adj_incremental_riskscore_i_all_coviddeath
    - cox_adj_incremental_riskscore_i_all_noncoviddeath
    - cox_adj_incremental_riskscore_i_all_fracture
    - cox_adj_incremental_riskscore_i_agegroup_match_covidadmitted
    - cox_adj_incremental_riskscore_i_agegroup_match_coviddeath
    - cox_adj_incremental_riskscore_i_agegroup_match_noncoviddeath
    - cox_adj_incremental_riskscore_i_agegroup_match_fracture
    outputs:
      moderately_sensitive:
        rds: output/incremental_riskscore_i/model/*.csv
        png: output/incremental_riskscore_i/model/*.png

  ## #### End #### 

