version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/*.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process initial data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_initial:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_initial
      --output-file output/initial/extract/input_initial.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/initial/extract/input_initial.feather

  dummydata_initial:
    run: r:latest analysis/dummydata/dummydata_initial.R
    needs:
    - extract_initial
    outputs:
      highly_sensitive:
        dummydata: output/initial/dummydata/*.feather

  process_initial:
    run: r:latest analysis/process/process_initial.R
    needs:
    - extract_initial
    - dummydata_initial
    outputs:
      highly_sensitive:
        data_eligible: output/initial/eligible/*.csv.gz
        data_vax: output/initial/eligible/*.rds
      moderately_sensitive:
        flowchart: output/initial/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/treated/extract/input_treated.feather
    needs:
    - process_initial
    outputs:
      highly_sensitive:
        extract: output/treated/extract/input_treated.feather

  dummydata_stage:
    run: r:latest analysis/dummydata/dummydata_stage.R
    needs:
    - dummydata_initial
    - process_initial
    - extract_treated
    outputs:
      highly_sensitive:
        dummydata_treated: output/treated/dummydata/*.feather
        dummydata_controlpotential: output/matchround1/controlpotential/dummydata/*.feather

  process_treated:
    run: r:latest analysis/process/process_stage.R treated
    needs:
    - process_initial
    - extract_treated
    - dummydata_stage
    outputs:
      highly_sensitive:
        eligiblerds: output/treated/eligible/*.rds
        eligiblecsv: output/treated/eligible/*.csv.gz
      moderately_sensitive:
        flowchart: output/treated/flowchart/*.csv
        extract_treated_skim: output/treated/extract/*.txt
        data_processed_skim: output/treated/process/*.txt
        data_eligible_skim: output/treated/eligible/*.txt

  ## # # # # # # # # # # # # # # # # # # # 
  ## Match treated for comparative effectiveness 
  ## # # # # # # # # # # # # # # # # # # # 

  match_comparative:
    run: r:latest analysis/match/match_comparative.R
    needs:
    - process_initial
    - process_treated
    outputs:
      highly_sensitive:
        rds: output/comparative/match/*.rds

  table1_match_comparative:
    run: r:latest analysis/report/table1.R match comparative
    needs:
    - process_treated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/table1/table1_match_comparative_rounded.csv
        html: output/comparative/table1/table1_match_comparative_rounded.html

  coverage_comparative:
    run: r:latest analysis/match/coverage.R comparative
    needs:
    - process_treated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/coverage/*.csv
        png: output/comparative/coverage/*.png

  flowchart_comparative:
    run: r:latest analysis/match/match_flowchart.R comparative
    needs:
    - process_treated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract, process and match control data 
  ## for relative effectiveness analysis 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_controlpotential_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround1/controlpotential/extract/input_controlpotential.feather
      --param match_round=1 --param index_date=2022-09-12
    needs:
    - design
    - process_initial
    outputs:
      highly_sensitive:
        cohort: output/matchround1/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_1:
    run: r:latest analysis/process/process_stage.R controlpotential 1
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_1
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround1/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround1/controlpotential/extract/*.txt
        data_processed_skim: output/matchround1/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround1/controlpotential/eligible/*.txt

  match_controlpotential_1:
    run: r:latest analysis/match/match_controlpotential.R 1
    needs:
    - process_treated
    - process_controlpotential_1
    outputs:
      highly_sensitive:
        rds: output/matchround1/controlpotential/match/*.rds
        csv: output/matchround1/controlpotential/match/*.csv.gz

  extract_controlactual_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround1/controlactual/extract/input_controlactual.feather
      --param match_round=1
    needs:
    - design
    - match_controlpotential_1
    outputs:
      highly_sensitive:
        cohort: output/matchround1/controlactual/extract/input_controlactual.feather

  process_controlactual_1:
    run: r:latest analysis/process/process_stage.R controlactual 1
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_1
    - extract_controlpotential_1
    - process_controlpotential_1
    - extract_controlactual_1
    outputs:
      highly_sensitive:
        rds: output/matchround1/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround1/controlactual/extract/*.txt
        eligible_skim: output/matchround1/controlactual/eligible/*.txt
        process_skim: output/matchround1/controlactual/process/*.txt

  extract_controlpotential_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround2/controlpotential/extract/input_controlpotential.feather
      --param match_round=2 --param index_date=2022-09-26
    needs:
    - design
    - process_initial
    - process_controlactual_1
    outputs:
      highly_sensitive:
        cohort: output/matchround2/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_2:
    run: r:latest analysis/process/process_stage.R controlpotential 2
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_2
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround2/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround2/controlpotential/extract/*.txt
        data_processed_skim: output/matchround2/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround2/controlpotential/eligible/*.txt

  match_controlpotential_2:
    run: r:latest analysis/match/match_controlpotential.R 2
    needs:
    - process_treated
    - process_controlpotential_2
    - process_controlactual_1
    outputs:
      highly_sensitive:
        rds: output/matchround2/controlpotential/match/*.rds
        csv: output/matchround2/controlpotential/match/*.csv.gz

  extract_controlactual_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround2/controlactual/extract/input_controlactual.feather
      --param match_round=2
    needs:
    - design
    - match_controlpotential_2
    outputs:
      highly_sensitive:
        cohort: output/matchround2/controlactual/extract/input_controlactual.feather

  process_controlactual_2:
    run: r:latest analysis/process/process_stage.R controlactual 2
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_2
    - extract_controlpotential_2
    - process_controlpotential_2
    - extract_controlactual_2
    - process_controlactual_1
    outputs:
      highly_sensitive:
        rds: output/matchround2/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround2/controlactual/extract/*.txt
        eligible_skim: output/matchround2/controlactual/eligible/*.txt
        process_skim: output/matchround2/controlactual/process/*.txt

  extract_controlpotential_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround3/controlpotential/extract/input_controlpotential.feather
      --param match_round=3 --param index_date=2022-10-10
    needs:
    - design
    - process_initial
    - process_controlactual_2
    outputs:
      highly_sensitive:
        cohort: output/matchround3/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_3:
    run: r:latest analysis/process/process_stage.R controlpotential 3
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_3
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround3/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround3/controlpotential/extract/*.txt
        data_processed_skim: output/matchround3/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround3/controlpotential/eligible/*.txt

  match_controlpotential_3:
    run: r:latest analysis/match/match_controlpotential.R 3
    needs:
    - process_treated
    - process_controlpotential_3
    - process_controlactual_2
    outputs:
      highly_sensitive:
        rds: output/matchround3/controlpotential/match/*.rds
        csv: output/matchround3/controlpotential/match/*.csv.gz

  extract_controlactual_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround3/controlactual/extract/input_controlactual.feather
      --param match_round=3
    needs:
    - design
    - match_controlpotential_3
    outputs:
      highly_sensitive:
        cohort: output/matchround3/controlactual/extract/input_controlactual.feather

  process_controlactual_3:
    run: r:latest analysis/process/process_stage.R controlactual 3
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_3
    - extract_controlpotential_3
    - process_controlpotential_3
    - extract_controlactual_3
    - process_controlactual_2
    outputs:
      highly_sensitive:
        rds: output/matchround3/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround3/controlactual/extract/*.txt
        eligible_skim: output/matchround3/controlactual/eligible/*.txt
        process_skim: output/matchround3/controlactual/process/*.txt

  extract_controlpotential_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround4/controlpotential/extract/input_controlpotential.feather
      --param match_round=4 --param index_date=2022-10-24
    needs:
    - design
    - process_initial
    - process_controlactual_3
    outputs:
      highly_sensitive:
        cohort: output/matchround4/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_4:
    run: r:latest analysis/process/process_stage.R controlpotential 4
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_4
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround4/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround4/controlpotential/extract/*.txt
        data_processed_skim: output/matchround4/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround4/controlpotential/eligible/*.txt

  match_controlpotential_4:
    run: r:latest analysis/match/match_controlpotential.R 4
    needs:
    - process_treated
    - process_controlpotential_4
    - process_controlactual_3
    outputs:
      highly_sensitive:
        rds: output/matchround4/controlpotential/match/*.rds
        csv: output/matchround4/controlpotential/match/*.csv.gz

  extract_controlactual_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround4/controlactual/extract/input_controlactual.feather
      --param match_round=4
    needs:
    - design
    - match_controlpotential_4
    outputs:
      highly_sensitive:
        cohort: output/matchround4/controlactual/extract/input_controlactual.feather

  process_controlactual_4:
    run: r:latest analysis/process/process_stage.R controlactual 4
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_4
    - extract_controlpotential_4
    - process_controlpotential_4
    - extract_controlactual_4
    - process_controlactual_3
    outputs:
      highly_sensitive:
        rds: output/matchround4/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround4/controlactual/extract/*.txt
        eligible_skim: output/matchround4/controlactual/eligible/*.txt
        process_skim: output/matchround4/controlactual/process/*.txt

  extract_controlpotential_5:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround5/controlpotential/extract/input_controlpotential.feather
      --param match_round=5 --param index_date=2022-11-07
    needs:
    - design
    - process_initial
    - process_controlactual_4
    outputs:
      highly_sensitive:
        cohort: output/matchround5/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_5:
    run: r:latest analysis/process/process_stage.R controlpotential 5
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_5
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround5/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround5/controlpotential/extract/*.txt
        data_processed_skim: output/matchround5/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround5/controlpotential/eligible/*.txt

  match_controlpotential_5:
    run: r:latest analysis/match/match_controlpotential.R 5
    needs:
    - process_treated
    - process_controlpotential_5
    - process_controlactual_4
    outputs:
      highly_sensitive:
        rds: output/matchround5/controlpotential/match/*.rds
        csv: output/matchround5/controlpotential/match/*.csv.gz

  extract_controlactual_5:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround5/controlactual/extract/input_controlactual.feather
      --param match_round=5
    needs:
    - design
    - match_controlpotential_5
    outputs:
      highly_sensitive:
        cohort: output/matchround5/controlactual/extract/input_controlactual.feather

  process_controlactual_5:
    run: r:latest analysis/process/process_stage.R controlactual 5
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_5
    - extract_controlpotential_5
    - process_controlpotential_5
    - extract_controlactual_5
    - process_controlactual_4
    outputs:
      highly_sensitive:
        rds: output/matchround5/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround5/controlactual/extract/*.txt
        eligible_skim: output/matchround5/controlactual/eligible/*.txt
        process_skim: output/matchround5/controlactual/process/*.txt

  extract_controlpotential_6:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround6/controlpotential/extract/input_controlpotential.feather
      --param match_round=6 --param index_date=2022-11-21
    needs:
    - design
    - process_initial
    - process_controlactual_5
    outputs:
      highly_sensitive:
        cohort: output/matchround6/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_6:
    run: r:latest analysis/process/process_stage.R controlpotential 6
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_6
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround6/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround6/controlpotential/extract/*.txt
        data_processed_skim: output/matchround6/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround6/controlpotential/eligible/*.txt

  match_controlpotential_6:
    run: r:latest analysis/match/match_controlpotential.R 6
    needs:
    - process_treated
    - process_controlpotential_6
    - process_controlactual_5
    outputs:
      highly_sensitive:
        rds: output/matchround6/controlpotential/match/*.rds
        csv: output/matchround6/controlpotential/match/*.csv.gz

  extract_controlactual_6:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround6/controlactual/extract/input_controlactual.feather
      --param match_round=6
    needs:
    - design
    - match_controlpotential_6
    outputs:
      highly_sensitive:
        cohort: output/matchround6/controlactual/extract/input_controlactual.feather

  process_controlactual_6:
    run: r:latest analysis/process/process_stage.R controlactual 6
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_6
    - extract_controlpotential_6
    - process_controlpotential_6
    - extract_controlactual_6
    - process_controlactual_5
    outputs:
      highly_sensitive:
        rds: output/matchround6/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround6/controlactual/extract/*.txt
        eligible_skim: output/matchround6/controlactual/eligible/*.txt
        process_skim: output/matchround6/controlactual/process/*.txt

  extract_controlpotential_7:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround7/controlpotential/extract/input_controlpotential.feather
      --param match_round=7 --param index_date=2022-12-05
    needs:
    - design
    - process_initial
    - process_controlactual_6
    outputs:
      highly_sensitive:
        cohort: output/matchround7/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_7:
    run: r:latest analysis/process/process_stage.R controlpotential 7
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_7
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround7/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround7/controlpotential/extract/*.txt
        data_processed_skim: output/matchround7/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround7/controlpotential/eligible/*.txt

  match_controlpotential_7:
    run: r:latest analysis/match/match_controlpotential.R 7
    needs:
    - process_treated
    - process_controlpotential_7
    - process_controlactual_6
    outputs:
      highly_sensitive:
        rds: output/matchround7/controlpotential/match/*.rds
        csv: output/matchround7/controlpotential/match/*.csv.gz

  extract_controlactual_7:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround7/controlactual/extract/input_controlactual.feather
      --param match_round=7
    needs:
    - design
    - match_controlpotential_7
    outputs:
      highly_sensitive:
        cohort: output/matchround7/controlactual/extract/input_controlactual.feather

  process_controlactual_7:
    run: r:latest analysis/process/process_stage.R controlactual 7
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_7
    - extract_controlpotential_7
    - process_controlpotential_7
    - extract_controlactual_7
    - process_controlactual_6
    outputs:
      highly_sensitive:
        rds: output/matchround7/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround7/controlactual/extract/*.txt
        eligible_skim: output/matchround7/controlactual/eligible/*.txt
        process_skim: output/matchround7/controlactual/process/*.txt

  extract_controlpotential_8:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/matchround8/controlpotential/extract/input_controlpotential.feather
      --param match_round=8 --param index_date=2022-12-19
    needs:
    - design
    - process_initial
    - process_controlactual_7
    outputs:
      highly_sensitive:
        cohort: output/matchround8/controlpotential/extract/input_controlpotential.feather

  process_controlpotential_8:
    run: r:latest analysis/process/process_stage.R controlpotential 8
    needs:
    - dummydata_stage
    - process_initial
    - extract_controlpotential_8
    outputs:
      highly_sensitive:
        eligible_rds: output/matchround8/controlpotential/eligible/*.rds
      moderately_sensitive:
        data_extract_skim: output/matchround8/controlpotential/extract/*.txt
        data_processed_skim: output/matchround8/controlpotential/process/*.txt
        data_controlpotential_skim: output/matchround8/controlpotential/eligible/*.txt

  match_controlpotential_8:
    run: r:latest analysis/match/match_controlpotential.R 8
    needs:
    - process_treated
    - process_controlpotential_8
    - process_controlactual_7
    outputs:
      highly_sensitive:
        rds: output/matchround8/controlpotential/match/*.rds
        csv: output/matchround8/controlpotential/match/*.csv.gz

  extract_controlactual_8:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/matchround8/controlactual/extract/input_controlactual.feather
      --param match_round=8
    needs:
    - design
    - match_controlpotential_8
    outputs:
      highly_sensitive:
        cohort: output/matchround8/controlactual/extract/input_controlactual.feather

  process_controlactual_8:
    run: r:latest analysis/process/process_stage.R controlactual 8
    needs:
    - process_initial
    - dummydata_stage
    - process_treated
    - match_controlpotential_8
    - extract_controlpotential_8
    - process_controlpotential_8
    - extract_controlactual_8
    - process_controlactual_7
    outputs:
      highly_sensitive:
        rds: output/matchround8/controlactual/match/*.rds
      moderately_sensitive:
        input_controlactual_skim: output/matchround8/controlactual/extract/*.txt
        eligible_skim: output/matchround8/controlactual/eligible/*.txt
        process_skim: output/matchround8/controlactual/process/*.txt

  table1_match_relative:
    run: r:latest analysis/report/table1.R match relative
    needs:
    - process_treated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    outputs:
      moderately_sensitive:
        csv: output/relative/table1/table1_match_relative_rounded.csv
        html: output/relative/table1/table1_match_relative_rounded.html

  coverage_relative:
    run: r:latest analysis/match/coverage.R relative
    needs:
    - process_treated
    - process_controlactual_8
    outputs:
      moderately_sensitive:
        csv: output/relative/coverage/*.csv
        png: output/relative/coverage/*.png

  flowchart_relative:
    run: r:latest analysis/match/match_flowchart.R relative
    needs:
    - process_treated
    - process_controlactual_8
    - process_initial
    outputs:
      moderately_sensitive:
        csv: output/relative/flowchart/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process covs and outcomes 
  ## for successfully matched data 
  ## (relative and comparative effectiveness) 
  ## # # # # # # # # # # # # # # # # # # # 
  ##  
  ## process_ids creates datasets of all matched treated and control ids 
  ## for whom to extract the covariates and outcomes 

  process_ids:
    run: r:latest analysis/process/process_ids.R
    needs:
    - process_treated
    - process_controlactual_8
    outputs:
      highly_sensitive:
        ids: output/postmatch/eligible/*.csv.gz

  extract_covs_alltreated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covs
      --output-file output/postmatch/covs/input_covs_alltreated.feather --param group=alltreated
    needs:
    - design
    - process_ids
    outputs:
      highly_sensitive:
        cohort: output/postmatch/covs/input_covs_alltreated.feather

  extract_covs_matchcontrol:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covs
      --output-file output/postmatch/covs/input_covs_matchcontrol.feather --param
      group=matchcontrol
    needs:
    - design
    - process_ids
    outputs:
      highly_sensitive:
        cohort: output/postmatch/covs/input_covs_matchcontrol.feather

  extract_outcomes_alltreated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_outcomes
      --output-file output/postmatch/outcomes/input_outcomes_alltreated.feather --param
      group=alltreated
    needs:
    - design
    - process_ids
    outputs:
      highly_sensitive:
        cohort: output/postmatch/outcomes/input_outcomes_alltreated.feather

  extract_outcomes_matchcontrol:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_outcomes
      --output-file output/postmatch/outcomes/input_outcomes_matchcontrol.feather
      --param group=matchcontrol
    needs:
    - design
    - process_ids
    outputs:
      highly_sensitive:
        cohort: output/postmatch/outcomes/input_outcomes_matchcontrol.feather

  table1_all_treated:
    run: r:latest analysis/report/table1.R all treated
    needs:
    - process_treated
    - extract_covs_alltreated
    outputs:
      moderately_sensitive:
        csv: output/treated/table1/table1_all_treated_rounded.csv
        html: output/treated/table1/table1_all_treated_rounded.html

  table1_covs_comparative:
    run: r:latest analysis/report/table1.R covs comparative
    needs:
    - process_treated
    - match_comparative
    - extract_covs_alltreated
    outputs:
      moderately_sensitive:
        csv: output/comparative/table1/table1_covs_comparative_rounded.csv
        html: output/comparative/table1/table1_covs_comparative_rounded.html

  table1_covs_relative:
    run: r:latest analysis/report/table1.R covs relative
    needs:
    - process_treated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_covs_alltreated
    - extract_covs_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/table1/table1_covs_relative_rounded.csv
        html: output/relative/table1/table1_covs_relative_rounded.html

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Combine outputs for report 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  combine_flowchart:
    run: r:latest analysis/report/combine_flowchart.R
    needs:
    - process_initial
    - process_treated
    - flowchart_comparative
    - flowchart_relative
    outputs:
      moderately_sensitive:
        flowchart: output/report/flowchart/*.csv

  combine_table1:
    run: r:latest analysis/report/combine_table1.R
    needs:
    - table1_match_comparative
    - table1_match_relative
    - table1_all_treated
    - table1_covs_comparative
    - table1_covs_relative
    outputs:
      moderately_sensitive:
        flowchart: output/report/table1/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Fit models to estimate comparative effectiveness 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_all_covidadmitted:
    run: r:latest analysis/model/km.R comparative all covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/all/covidadmitted/*.csv
        png: output/comparative/model/km/all/covidadmitted/*.png

  cox_unadj_comparative_all_covidadmitted:
    run: r:latest analysis/model/cox.R comparative cox_unadj all covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_unadj/all/covidadmitted/*.csv

  cox_adj_comparative_all_covidadmitted:
    run: r:latest analysis/model/cox.R comparative cox_adj all covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    - extract_covs_alltreated
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_adj/all/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_all_coviddeath:
    run: r:latest analysis/model/km.R comparative all coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/all/coviddeath/*.csv
        png: output/comparative/model/km/all/coviddeath/*.png

  cox_unadj_comparative_all_coviddeath:
    run: r:latest analysis/model/cox.R comparative cox_unadj all coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_unadj/all/coviddeath/*.csv

  cox_adj_comparative_all_coviddeath:
    run: r:latest analysis/model/cox.R comparative cox_adj all coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    - extract_covs_alltreated
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_adj/all/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_all_noncoviddeath:
    run: r:latest analysis/model/km.R comparative all noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/all/noncoviddeath/*.csv
        png: output/comparative/model/km/all/noncoviddeath/*.png

  cox_unadj_comparative_all_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative cox_unadj all noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_unadj/all/noncoviddeath/*.csv

  cox_adj_comparative_all_noncoviddeath:
    run: r:latest analysis/model/cox.R comparative cox_adj all noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    - extract_covs_alltreated
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_adj/all/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_all_fracture:
    run: r:latest analysis/model/km.R comparative all fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/all/fracture/*.csv
        png: output/comparative/model/km/all/fracture/*.png

  cox_unadj_comparative_all_fracture:
    run: r:latest analysis/model/cox.R comparative cox_unadj all fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_unadj/all/fracture/*.csv

  cox_adj_comparative_all_fracture:
    run: r:latest analysis/model/cox.R comparative cox_adj all fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    - extract_covs_alltreated
    outputs:
      moderately_sensitive:
        csv: output/comparative/model/cox_adj/all/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_agegroup_match_covidadmitted:
    run: r:latest analysis/model/km.R comparative agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/agegroup_match/covidadmitted/*.csv
        png: output/comparative/model/km/agegroup_match/covidadmitted/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_agegroup_match_coviddeath:
    run: r:latest analysis/model/km.R comparative agegroup_match coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/agegroup_match/coviddeath/*.csv
        png: output/comparative/model/km/agegroup_match/coviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/km.R comparative agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/agegroup_match/noncoviddeath/*.csv
        png: output/comparative/model/km/agegroup_match/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_comparative_agegroup_match_fracture:
    run: r:latest analysis/model/km.R comparative agegroup_match fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - match_comparative
    outputs:
      moderately_sensitive:
        rds: output/comparative/model/km/agegroup_match/fracture/*.csv
        png: output/comparative/model/km/agegroup_match/fracture/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## Fit models to estimate relative effectiveness 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_all_covidadmitted:
    run: r:latest analysis/model/km.R relative all covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/all/covidadmitted/*.csv
        png: output/relative/model/km/all/covidadmitted/*.png

  cox_unadj_relative_all_covidadmitted:
    run: r:latest analysis/model/cox.R relative cox_unadj all covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_unadj/all/covidadmitted/*.csv

  cox_adj_relative_all_covidadmitted:
    run: r:latest analysis/model/cox.R relative cox_adj all covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    - extract_covs_alltreated
    - extract_covs_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_adj/all/covidadmitted/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_all_coviddeath:
    run: r:latest analysis/model/km.R relative all coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/all/coviddeath/*.csv
        png: output/relative/model/km/all/coviddeath/*.png

  cox_unadj_relative_all_coviddeath:
    run: r:latest analysis/model/cox.R relative cox_unadj all coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_unadj/all/coviddeath/*.csv

  cox_adj_relative_all_coviddeath:
    run: r:latest analysis/model/cox.R relative cox_adj all coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    - extract_covs_alltreated
    - extract_covs_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_adj/all/coviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_all_noncoviddeath:
    run: r:latest analysis/model/km.R relative all noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/all/noncoviddeath/*.csv
        png: output/relative/model/km/all/noncoviddeath/*.png

  cox_unadj_relative_all_noncoviddeath:
    run: r:latest analysis/model/cox.R relative cox_unadj all noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_unadj/all/noncoviddeath/*.csv

  cox_adj_relative_all_noncoviddeath:
    run: r:latest analysis/model/cox.R relative cox_adj all noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    - extract_covs_alltreated
    - extract_covs_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_adj/all/noncoviddeath/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=all; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_all_fracture:
    run: r:latest analysis/model/km.R relative all fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/all/fracture/*.csv
        png: output/relative/model/km/all/fracture/*.png

  cox_unadj_relative_all_fracture:
    run: r:latest analysis/model/cox.R relative cox_unadj all fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_unadj/all/fracture/*.csv

  cox_adj_relative_all_fracture:
    run: r:latest analysis/model/cox.R relative cox_adj all fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    - extract_covs_alltreated
    - extract_covs_matchcontrol
    outputs:
      moderately_sensitive:
        csv: output/relative/model/cox_adj/all/fracture/*.csv

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=covidadmitted; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_agegroup_match_covidadmitted:
    run: r:latest analysis/model/km.R relative agegroup_match covidadmitted
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/agegroup_match/covidadmitted/*.csv
        png: output/relative/model/km/agegroup_match/covidadmitted/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=coviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_agegroup_match_coviddeath:
    run: r:latest analysis/model/km.R relative agegroup_match coviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/agegroup_match/coviddeath/*.csv
        png: output/relative/model/km/agegroup_match/coviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=noncoviddeath; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_agegroup_match_noncoviddeath:
    run: r:latest analysis/model/km.R relative agegroup_match noncoviddeath
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/agegroup_match/noncoviddeath/*.csv
        png: output/relative/model/km/agegroup_match/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  
  ## subgroup=agegroup_match; outcome=fracture; 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # #  

  km_relative_agegroup_match_fracture:
    run: r:latest analysis/model/km.R relative agegroup_match fracture
    needs:
    - process_treated
    - extract_outcomes_alltreated
    - process_controlactual_1
    - process_controlactual_2
    - process_controlactual_3
    - process_controlactual_4
    - process_controlactual_5
    - process_controlactual_6
    - process_controlactual_7
    - process_controlactual_8
    - extract_outcomes_matchcontrol
    outputs:
      moderately_sensitive:
        rds: output/relative/model/km/agegroup_match/fracture/*.csv
        png: output/relative/model/km/agegroup_match/fracture/*.png

  ## #### End #### 

